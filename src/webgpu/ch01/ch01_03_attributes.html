<html>
  <head>
    <title>Real-Time 3D Graphics with WebGPU</title>
    <link
      rel="shortcut icon"
      type="image/png"
      href="/common/images/favicon.png"
    />

    <style>
      canvas {
        border: 5px dotted blue;
      }
    </style>

    <script type="text/javascript">
      "use strict";

      async function init() {
        const canvas = document.getElementById("webgpu-canvas");
        if (!canvas) {
          console.error("Sorry! No HTML5 Canvas was found on this page");
          return;
        }

        // アダプターとデバイスをリクエストする
        if (!navigator.gpu) {
          alert("Sorry! WebGPU is not available");
          return;
        }

        const adapter = await navigator.gpu.requestAdapter();
        if (!adapter) {
          alert("No appropriate GPUAdapter found.");
          return;
        }

        const device = await adapter.requestDevice();

        // キャンバスを構成する
        const context = canvas.getContext("webgpu");
        const format = navigator.gpu.getPreferredCanvasFormat();
        context.configure({
          device: device,
          format: format,
          alphaMode: "opaque",
        });

        // キャンバスをクリアする
        const clearColor = { r: 0, g: 0, b: 0, a: 1 };

        function updateClearColor(r, g, b, a) {
          clearColor.r = r;
          clearColor.g = g;
          clearColor.b = b;
          clearColor.a = a;

          const commandEncoder = device.createCommandEncoder();
          const textureView = context.getCurrentTexture().createView();
          const renderPassDescriptor = {
            colorAttachments: [
              {
                view: textureView,
                loadOp: "clear", // レンダリング パス開始時にテクスチャをクリアすることを示します。
                storeOp: "store", // レンダリング パスが終了したら、レンダリング パスで行われたすべての描画処理の結果をテクスチャに保存することを示します。
                clearValue: [
                  clearColor.r,
                  clearColor.g,
                  clearColor.b,
                  clearColor.a,
                ],
              },
            ],
          };
          const passEncoder =
            commandEncoder.beginRenderPass(renderPassDescriptor);
          passEncoder.end();

          device.queue.submit([commandEncoder.finish()]);
        }

        function checkKey(event) {
          console.log(`Key pressed: ${event.key}`); // Debug statement

          const key = event.key; // 使用event.key代替event.keyCode
          switch (key) {
            case "1": // 数字1
              updateClearColor(0.2, 0.8, 0.2, 1.0);
              break;
            case "2": // 数字2
              updateClearColor(0.2, 0.2, 0.8, 1.0);
              break;
            case "3": // 数字3
              updateClearColor(
                Math.random(),
                Math.random(),
                Math.random(),
                1.0
              );
              break;
            case "4": // 数字4
              alert(
                `clearColor = (${clearColor.r.toFixed(
                  1
                )}, ${clearColor.g.toFixed(1)}, ${clearColor.b.toFixed(1)})`
              );
              window.focus();
              break;
          }
        }

        window.onkeydown = checkKey;

        alert("Hooray! You got a WebGPU context");
      }

      window.onload = init;
    </script>
  </head>
  <body>
    <canvas id="webgpu-canvas" width="800" height="600">
      Your browser does not support the HTML5 canvas element.
    </canvas>
  </body>
</html>
